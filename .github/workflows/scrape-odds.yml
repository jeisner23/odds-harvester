name: Scrape Soccer Odds

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  europe-major:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install playwright aiohttp fake_useragent tenacity boto3 beautifulsoup4 lxml
          playwright install chromium
          playwright install-deps chromium
      
      - name: Set dates
        id: dates
        run: |
          echo "TODAY=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "TOMORROW=$(date -u -d '+1 day' +%Y%m%d)" >> $GITHUB_OUTPUT
      
      - name: Scrape Europe Major - Today
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TODAY }} \
            --leagues premier-league,championship,league-one,league-two,la-liga,la-liga-2,bundesliga,2-bundesliga,serie-a,serie-b,ligue-1,ligue-2,eredivisie,primeira-liga,jupiler-pro-league,super-lig,scottish-premiership,scottish-championship \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/europe_major_today.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Scrape Europe Major - Tomorrow
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TOMORROW }} \
            --leagues premier-league,championship,league-one,league-two,la-liga,la-liga-2,bundesliga,2-bundesliga,serie-a,serie-b,ligue-1,ligue-2,eredivisie,primeira-liga,jupiler-pro-league,super-lig,scottish-premiership,scottish-championship \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/europe_major_tomorrow.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: europe-major
          path: data/*.json
          retention-days: 1

  europe-secondary:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install playwright aiohttp fake_useragent tenacity boto3 beautifulsoup4 lxml
          playwright install chromium
          playwright install-deps chromium
      
      - name: Set dates
        id: dates
        run: |
          echo "TODAY=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "TOMORROW=$(date -u -d '+1 day' +%Y%m%d)" >> $GITHUB_OUTPUT
      
      - name: Scrape Europe Secondary - Today
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TODAY }} \
            --leagues superliga,eliteserien,allsvenskan,ekstraklasa,1-liga,fortuna-liga,bundesliga-austria,super-league-switzerland,super-league-greece,superliga-romania,hnl,superliga-serbia,premier-league-ukraine,russian-premier-league,veikkausliiga \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/europe_secondary_today.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Scrape Europe Secondary - Tomorrow
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TOMORROW }} \
            --leagues superliga,eliteserien,allsvenskan,ekstraklasa,1-liga,fortuna-liga,bundesliga-austria,super-league-switzerland,super-league-greece,superliga-romania,hnl,superliga-serbia,premier-league-ukraine,russian-premier-league,veikkausliiga \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/europe_secondary_tomorrow.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: europe-secondary
          path: data/*.json
          retention-days: 1

  europe-small:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install playwright aiohttp fake_useragent tenacity boto3 beautifulsoup4 lxml
          playwright install chromium
          playwright install-deps chromium
      
      - name: Set dates
        id: dates
        run: |
          echo "TODAY=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "TOMORROW=$(date -u -d '+1 day' +%Y%m%d)" >> $GITHUB_OUTPUT
      
      - name: Scrape Europe Small - Today
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TODAY }} \
            --leagues ligat-haal,first-division,parva-liga,super-league-albania,premijer-liga-bih,vysshaya-liga,a-lyga,virsliga,meistriliiga,prva-liga,nifl-premiership,cymru-premier \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/europe_small_today.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Scrape Europe Small - Tomorrow
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TOMORROW }} \
            --leagues ligat-haal,first-division,parva-liga,super-league-albania,premijer-liga-bih,vysshaya-liga,a-lyga,virsliga,meistriliiga,prva-liga,nifl-premiership,cymru-premier \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/europe_small_tomorrow.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: europe-small
          path: data/*.json
          retention-days: 1

  uefa:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install playwright aiohttp fake_useragent tenacity boto3 beautifulsoup4 lxml
          playwright install chromium
          playwright install-deps chromium
      
      - name: Set dates
        id: dates
        run: |
          echo "TODAY=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "TOMORROW=$(date -u -d '+1 day' +%Y%m%d)" >> $GITHUB_OUTPUT
      
      - name: Scrape UEFA - Today
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TODAY }} \
            --leagues champions-league,europa-league,conference-league,euro,euro-qualification,nations-league,world-cup,world-cup-qualification-europe,world-cup-qualification-south-america,world-cup-qualification-africa,world-cup-qualification-asia,world-cup-qualification-concacaf \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/uefa_today.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Scrape UEFA - Tomorrow
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TOMORROW }} \
            --leagues champions-league,europa-league,conference-league,euro,euro-qualification,nations-league,world-cup,world-cup-qualification-europe,world-cup-qualification-south-america,world-cup-qualification-africa,world-cup-qualification-asia,world-cup-qualification-concacaf \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/uefa_tomorrow.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: uefa
          path: data/*.json
          retention-days: 1

  americas-north:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install playwright aiohttp fake_useragent tenacity boto3 beautifulsoup4 lxml
          playwright install chromium
          playwright install-deps chromium
      
      - name: Set dates
        id: dates
        run: |
          echo "TODAY=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "TOMORROW=$(date -u -d '+1 day' +%Y%m%d)" >> $GITHUB_OUTPUT
      
      - name: Scrape Americas North - Today
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TODAY }} \
            --leagues mls,usl-championship,liga-mx,liga-expansion-mx,cpl,concacaf-champions-cup,concacaf-league,liga-nacional-guatemala,primera-division-costa-rica \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/americas_north_today.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Scrape Americas North - Tomorrow
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TOMORROW }} \
            --leagues mls,usl-championship,liga-mx,liga-expansion-mx,cpl,concacaf-champions-cup,concacaf-league,liga-nacional-guatemala,primera-division-costa-rica \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/americas_north_tomorrow.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: americas-north
          path: data/*.json
          retention-days: 1

  americas-south:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install playwright aiohttp fake_useragent tenacity boto3 beautifulsoup4 lxml
          playwright install chromium
          playwright install-deps chromium
      
      - name: Set dates
        id: dates
        run: |
          echo "TODAY=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "TOMORROW=$(date -u -d '+1 day' +%Y%m%d)" >> $GITHUB_OUTPUT
      
      - name: Scrape Americas South - Today
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TODAY }} \
            --leagues serie-a-brazil,serie-b-brazil,copa-do-brasil,primera-division-argentina,primera-nacional,liga-profesional-chile,liga-betplay,liga-1-peru,ligapro-ecuador,primera-division-uruguay,primera-division-paraguay,copa-libertadores,copa-sudamericana \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/americas_south_today.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Scrape Americas South - Tomorrow
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TOMORROW }} \
            --leagues serie-a-brazil,serie-b-brazil,copa-do-brasil,primera-division-argentina,primera-nacional,liga-profesional-chile,liga-betplay,liga-1-peru,ligapro-ecuador,primera-division-uruguay,primera-division-paraguay,copa-libertadores,copa-sudamericana \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/americas_south_tomorrow.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: americas-south
          path: data/*.json
          retention-days: 1

  asia-east:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install playwright aiohttp fake_useragent tenacity boto3 beautifulsoup4 lxml
          playwright install chromium
          playwright install-deps chromium
      
      - name: Set dates
        id: dates
        run: |
          echo "TODAY=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "TOMORROW=$(date -u -d '+1 day' +%Y%m%d)" >> $GITHUB_OUTPUT
      
      - name: Scrape Asia East - Today
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TODAY }} \
            --leagues j1-league,j2-league,j3-league,k-league-1,k-league-2,chinese-super-league,v-league-1,thai-league,malaysian-super-league,singapore-premier-league,indonesia-liga-1,afc-champions-league \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/asia_east_today.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Scrape Asia East - Tomorrow
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TOMORROW }} \
            --leagues j1-league,j2-league,j3-league,k-league-1,k-league-2,chinese-super-league,v-league-1,thai-league,malaysian-super-league,singapore-premier-league,indonesia-liga-1,afc-champions-league \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/asia_east_tomorrow.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: asia-east
          path: data/*.json
          retention-days: 1

  asia-west:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install playwright aiohttp fake_useragent tenacity boto3 beautifulsoup4 lxml
          playwright install chromium
          playwright install-deps chromium
      
      - name: Set dates
        id: dates
        run: |
          echo "TODAY=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "TOMORROW=$(date -u -d '+1 day' +%Y%m%d)" >> $GITHUB_OUTPUT
      
      - name: Scrape Asia West - Today
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TODAY }} \
            --leagues saudi-pro-league,stars-league,uae-pro-league,kuwait-premier-league,bahrain-premier-league,iraqi-premier-league,persian-gulf-pro-league,indian-super-league,i-league,uzbekistan-super-league,kazakhstan-premier-league \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/asia_west_today.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Scrape Asia West - Tomorrow
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TOMORROW }} \
            --leagues saudi-pro-league,stars-league,uae-pro-league,kuwait-premier-league,bahrain-premier-league,iraqi-premier-league,persian-gulf-pro-league,indian-super-league,i-league,uzbekistan-super-league,kazakhstan-premier-league \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/asia_west_tomorrow.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: asia-west
          path: data/*.json
          retention-days: 1

  africa-oceania:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install playwright aiohttp fake_useragent tenacity boto3 beautifulsoup4 lxml
          playwright install chromium
          playwright install-deps chromium
      
      - name: Set dates
        id: dates
        run: |
          echo "TODAY=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "TOMORROW=$(date -u -d '+1 day' +%Y%m%d)" >> $GITHUB_OUTPUT
      
      - name: Scrape Africa/Oceania - Today
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TODAY }} \
            --leagues premier-league-egypt,botola-pro,ligue-1-tunisia,premier-soccer-league,premier-league-algeria,ghana-premier-league,npfl,caf-champions-league,caf-confederation-cup,a-league \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/africa_oceania_today.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Scrape Africa/Oceania - Tomorrow
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python src/main.py scrape_upcoming \
            --sport football \
            --date ${{ steps.dates.outputs.TOMORROW }} \
            --leagues premier-league-egypt,botola-pro,ligue-1-tunisia,premier-soccer-league,premier-league-algeria,ghana-premier-league,npfl,caf-champions-league,caf-confederation-cup,a-league \
            --markets 1x2,over_under,btts \
            --headless \
            --file_path data/africa_oceania_tomorrow.json \
            --format json \
            --concurrency_tasks 3
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: africa-oceania
          path: data/*.json
          retention-days: 1

  merge:
    needs: [europe-major, europe-secondary, europe-small, uefa, americas-north, americas-south, asia-east, asia-west, africa-oceania]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Merge all odds files
        run: python scripts/merge_odds.py
      
      - name: Upload odds to Gist
        uses: exuanbo/actions-deploy-gist@v1
        with:
          token: ${{ secrets.GIST_TOKEN }}
          gist_id: ${{ secrets.GIST_ID }}
          file_path: data/odds.json
          file_type: text
